Creat a directory that contains the following files: 

  1) the pdb file for your protein (in this document we will call it protein.pdb)
  2) combine.tcl (shown below)

```sh
#remove loaded structures
mol delete all

# need psfgen module and topology
package require psfgen
topology /path/to/top_all27_prot_lipid.inp

# load structures
# change the filenames if needed
resetpsf
readpsf membrane.psf
coordpdb membrane.pdb
readpsf protein_aligned_autopsf.psf
coordpdb protein_aligned_autopsf.pdb

# write temporary structure
set temp "temp"
writepsf $temp.psf
writepdb $temp.pdb

# reload full structure (do NOT resetpsf!)
mol load psf $temp.psf pdb $temp.pdb

# select and delete lipids that overlap protein:
# any atom to any atom distance under 0.8A
# (alternative: heavy atom to heavy atom distance under 1.3A)
set sellip [atomselect top "resname POPC"]
set lseglist [lsort -unique [$sellip get segid]]
foreach lseg $lseglist {
  # find lipid backbone atoms
  set selover [atomselect top "segid $lseg and within 0.8 of protein"]
  # delete these residues
  set resover [lsort -unique [$selover get resid]]
  foreach res $resover {
    delatom $lseg $res
  }
}

# delete lipids that stick into gaps in protein
foreach res { } {delatom $LIP1 $res}
foreach res { } {delatom $LIP2 $res}

# write full structure
writepsf protein_mem.psf
writepdb protein_mem.pdb

# clean up
file delete $temp.psf
file delete $temp.pdb
```

The above script will vary depend on how you setup VMD and your input file, CHANGE (please) the script accordingly. 

Open VMD and open the Tk Console by clicking `Extension` --> `Tk Console` in `VMD MAIN`.

In Console, cd to the directory you just created. Load protein.pdb into VMD. 

Generate the membrane by typing `membrane -l <lipid_name> -x <size_in_X> -y <size_in_Y> {-o <output_prefix>}`. 

  1) `lipid_name` can only be `POPC` or `POPE`.
  2) `size_in_X` and size_in_Y` are the membrane dumensions in angstrom.
  3) `output_prefix` is an optional parameter that specify the output file name. By default, the generated files are named `membrane.psf` and `membrane.pdb`.

Align the protein to the proper position and orientation in the membrane. This can be easily done using the VMD GUI front end
  1) press "8" key to switch VMD to "move molecule"mode.
  2) holding down the left mouse button while moving the mouse will move the molecule.
  3) holding down "shift" key and the left mouse button while moveing the mouse will rotate the molecule.

Once the protein is properly aligned in the membrane, save the coordinate of the protein into a new file `protein_aligned.pdb`.

In Console, type `mol delete all` to remove all the loaded structures. Then load `protein_aligned.pdb` into VMD. In `VMD MAIN`, click `Extensions` --> `Modelling` --> `Automatic PSF Builder`. This should pop up a new window called `AutoPSF`. Follow the steps in this window and it should generate `protein_aligned_autopsf.psf` and `protein_aligened_autopsf.pdb`. These two files along with `membrane.psf` and `membrane.pdb` will be used in the next step. 

In Console, type `vmd -dispdev text < combine.tcl > combine.log` to run the script. 

Load the structure generated by the script (`protein_mem.pdb` if you didn't change the output file names in the script) to double check the protein is properly embedded (e.g., no lipid overlapping with the protein).


P.S. If you can not run combine.tcl, just manually type all the commands in Console.
